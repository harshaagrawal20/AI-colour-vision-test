<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D-15 Color Vision AI Test - Powered by Gemini</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header .subtitle {
            color: #666;
            font-size: 1.1em;
        }

        .gemini-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, #4285F4, #34A853, #FBBC04, #EA4335);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            margin-top: 10px;
        }

        .section {
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 20px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 12px;
            padding: 50px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9ff;
        }

        .upload-area:hover {
            border-color: #764ba2;
            background: #f0f2ff;
            transform: translateY(-2px);
        }

        .upload-area input {
            display: none;
        }

        .upload-icon {
            font-size: 4em;
            margin-bottom: 15px;
        }

        .hidden {
            display: none !important;
        }

        .loading {
            text-align: center;
            padding: 30px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .patch-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
            justify-content: center;
            padding: 20px;
            background: #f8f9ff;
            border-radius: 12px;
        }

        .patch {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            cursor: grab;
            border: 3px solid transparent;
            transition: all 0.2s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .patch:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.25);
        }

        .patch.used {
            opacity: 0.3;
            cursor: not-allowed;
            pointer-events: none;
        }

        .ordering-zone {
            background: white;
            border: 3px dashed #667eea;
            border-radius: 12px;
            padding: 20px;
            min-height: 120px;
            margin: 20px 0;
            overflow-x: auto;
        }

        .ordered-patches {
            display: flex;
            gap: 10px;
            align-items: center;
            min-width: max-content;
        }

        .ordered-patch {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            border: 3px solid #667eea;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .ordered-patch:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
        }

        .empty-slot {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            border: 3px dashed #ccc;
            background: #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 0.8em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .empty-slot:hover {
            background: #e8f0ff;
            border-color: #667eea;
        }

        .patch-index {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 24px;
            height: 24px;
            background: #667eea;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7em;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 32px;
            font-size: 1em;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px 5px;
            font-weight: 600;
        }

        .button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(102, 126, 234, 0.4);
        }

        .button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .button-secondary {
            background: linear-gradient(135deg, #6c757d, #5a6268);
        }

        .d15-graph-container {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 25px;
            margin: 25px 0;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .d15-graph-container h3 {
            margin-top: 0;
        }

        .gemini-analysis {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border: 3px solid #4285F4;
            border-radius: 16px;
            padding: 30px;
            margin-top: 30px;
            box-shadow: 0 8px 24px rgba(66, 133, 244, 0.15);
        }

        .gemini-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .gemini-logo {
            width: 32px;
            height: 32px;
        }

        .gemini-header h2 {
            color: #1a73e8;
            font-size: 1.6em;
            margin: 0;
        }

        .gemini-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            line-height: 1.8;
            color: #333;
            max-height: 700px;
            overflow-y: auto;
            font-size: 0.95em;
        }

        .gemini-content h2 {
            color: #1a73e8;
            font-size: 1.4em;
            margin-top: 25px;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e8f0fe;
        }

        .gemini-content h3 {
            color: #34A853;
            font-size: 1.2em;
            margin-top: 20px;
            margin-bottom: 10px;
        }

        .gemini-content h4 {
            color: #FBBC04;
            font-size: 1.05em;
            margin-top: 15px;
            margin-bottom: 8px;
        }

        .gemini-content ul {
            margin-left: 25px;
            margin-bottom: 15px;
        }

        .gemini-content li {
            margin-bottom: 8px;
        }

        .gemini-content strong {
            color: #1a73e8;
            font-weight: 600;
        }

        .gemini-content code {
            background: #f0f0f0;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }

        .loading-gemini {
            text-align: center;
            padding: 40px;
        }

        .loading-gemini .spinner {
            border-top-color: #4285F4;
        }

        .loading-gemini p {
            color: #1a73e8;
            font-size: 1.1em;
            margin-top: 15px;
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 5px solid #c62828;
        }

        .success-message {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 5px solid #2e7d32;
        }

        .info-box {
            background: #e3f2fd;
            border-left: 5px solid #2196F3;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }

        .info-box strong {
            color: #1976D2;
        }

        .disclaimer {
            background: #fff3e0;
            border: 2px solid #ff9800;
            border-radius: 8px;
            padding: 20px;
            margin-top: 30px;
            font-size: 0.9em;
            line-height: 1.6;
        }

        .disclaimer strong {
            color: #e65100;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            .header h1 {
                font-size: 1.8em;
            }

            .patch, .ordered-patch, .empty-slot {
                width: 50px;
                height: 50px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé® D-15 Color Vision Test</h1>
            <p class="subtitle">AI-Powered Color Vision Analysis</p>
        </div>

        <!-- Step 1: Upload -->
        <div class="section" id="upload-section">
            <div class="section-title">Step 1: Upload Your Image</div>
            <div class="info-box">
                <strong>üì∏ Instructions:</strong> Upload any colorful image (nature, art, photos). 
                We'll extract 15 dominant colors and create a personalized D-15 color arrangement test.
            </div>
            <div class="upload-area" id="upload-area">
                <div class="upload-icon">üìÅ</div>
                <div style="font-size: 1.2em; margin-bottom: 10px; color: #667eea; font-weight: 600;">
                    Drop your image here or click to browse
                </div>
                <div style="color: #999; font-size: 0.9em;">
                    Supported: JPG, PNG, WebP, GIF
                </div>
                <input type="file" id="file-input" accept="image/*">
            </div>
            <div id="upload-error" class="error-message hidden"></div>
            <div id="upload-loading" class="loading hidden">
                <div class="spinner"></div>
                <p style="color: #667eea; font-size: 1.1em;">Analyzing image and generating test...</p>
            </div>
        </div>

        <!-- Step 2: Test -->
        <div class="section hidden" id="test-section">
            <div class="section-title">Step 2: Arrange the Colors</div>
            <div class="info-box">
                <strong>üéØ How to complete the test:</strong>
                <ol style="margin-left: 20px; margin-top: 10px;">
                    <li>Drag colors from the pool below one at a time</li>
                    <li>Arrange them horizontally from similar to similar hues</li>
                    <li>Each color can only be used once</li>
                    <li>Click on arranged colors to remove them</li>
                    <li>Submit when all colors are arranged</li>
                </ol>
            </div>
            
            <!-- Reference Color Display -->
            <div style="margin-bottom: 20px;">
                <div style="font-weight: bold; color: #667eea; margin-bottom: 10px; font-size: 1.1em;">
                    Reference Color:
                </div>
                <div id="reference-pad" style="width: 80px; height: 80px; border-radius: 12px; border: 4px solid #667eea; box-shadow: 0 4px 12px rgba(0,0,0,0.15); margin-bottom: 20px;">
                </div>
            </div>

            <div style="margin-bottom: 20px;">
                <div style="font-weight: bold; color: #667eea; margin-bottom: 10px; font-size: 1.1em;">
                    Available Colors:
                </div>
                <div class="patch-grid" id="patch-grid"></div>
            </div>

            <div style="font-weight: bold; color: #667eea; margin-bottom: 10px; font-size: 1.1em;">
                Your Arrangement (<span id="progress-count">0</span>/<span id="total-count">14</span> placed):
            </div>
            <div class="ordering-zone">
                <div class="ordered-patches" id="ordered-patches"></div>
            </div>

            <div id="test-error" class="error-message hidden"></div>

            <div style="text-align: center; margin-top: 30px;">
                <button class="button" id="submit-btn" disabled>
                    üß™ Submit for AI Analysis
                </button>
                <button class="button button-secondary" id="reset-btn">
                    üîÑ Reset Arrangement
                </button>
                <button class="button button-secondary" id="upload-new-btn">
                    üì∏ Upload New Image
                </button>
            </div>
        </div>

        <!-- Step 3: Results -->
        <div class="section hidden" id="results-section">
            <div class="section-title">Step 3: Your Color Vision Analysis</div>
            
            <div id="results-loading" class="loading-gemini">
                <div class="spinner"></div>
                <p>ü§ñ Gemini AI is analyzing your results...</p>
                <p style="font-size: 0.9em; color: #666; margin-top: 10px;">
                    This may take 10-20 seconds
                </p>
            </div>

            <!-- D-15 Graph -->
            <div id="d15-graph-container" class="d15-graph-container hidden">
                <h3 style="color: #1a73e8; margin-bottom: 15px;">üìä Your D-15 Test Result Graph</h3>
                <img id="d15-graph" alt="D-15 Test Result Graph" style="max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                <p style="font-size: 0.9em; color: #666; margin-top: 10px;">
                    The circular diagram shows your color arrangement pattern. Line crossings indicate color confusion areas.
                </p>
            </div>

            <!-- Hue Spectrum Error Visualization -->
            <div id="hue-spectrum-container" class="d15-graph-container hidden">
                <h3 style="color: #1a73e8; margin-bottom: 15px;">üåà Hue Spectrum Analysis</h3>
                <img id="hue-spectrum" alt="Hue Spectrum Error Visualization" style="max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                <p style="font-size: 0.9em; color: #666; margin-top: 10px;">
                    This shows where each color appears on the hue spectrum. Green borders = correct placement, Red borders = errors with arrows showing where they should be.
                </p>
            </div>

            <!-- Gemini AI Analysis -->
            <div id="gemini-analysis" class="gemini-analysis hidden">
                <div class="gemini-header">
                    <svg class="gemini-logo" viewBox="0 0 24 24" fill="none">
                        <path d="M12 2L2 7L12 12L22 7L12 2Z" fill="#4285F4"/>
                        <path d="M2 17L12 22L22 17L12 12L2 17Z" fill="#34A853"/>
                        <path d="M2 12L12 17L22 12" stroke="#FBBC04" stroke-width="2"/>
                    </svg>
                    <h2>Comprehensive Medical Analysis</h2>
                </div>
                <div id="gemini-content" class="gemini-content"></div>
            </div>

            <div class="disclaimer">
                <strong>‚ö†Ô∏è Medical Disclaimer:</strong> This is an AI-powered screening tool for educational purposes only. 
                It is NOT a substitute for professional medical diagnosis. For accurate diagnosis and treatment, 
                please consult a qualified ophthalmologist or optometrist. Color vision deficiencies affect approximately 
                8% of males and 0.5% of females, and early detection helps with appropriate accommodations.
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button class="button" id="test-again-btn">
                    üîÅ Take Test Again
                </button>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE = 'http://localhost:8000';
        
        // Global state
        let sessionId = null;
        let testSpec = null;
        let userOrder = [];
        let draggedElement = null;

        // DOM elements
        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.getElementById('file-input');
        const uploadSection = document.getElementById('upload-section');
        const testSection = document.getElementById('test-section');
        const resultsSection = document.getElementById('results-section');
        const patchGrid = document.getElementById('patch-grid');
        const submitBtn = document.getElementById('submit-btn');

        // Upload handlers
        uploadArea.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFileSelect);
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.transform = 'scale(1.02)';
            uploadArea.style.borderColor = '#764ba2';
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.style.transform = 'scale(1)';
            uploadArea.style.borderColor = '#667eea';
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.transform = 'scale(1)';
            if (e.dataTransfer.files.length) {
                fileInput.files = e.dataTransfer.files;
                handleFileSelect();
            }
        });

        async function handleFileSelect() {
            const file = fileInput.files[0];
            if (!file) return;

            document.getElementById('upload-loading').classList.remove('hidden');
            document.getElementById('upload-error').classList.add('hidden');

            try {
                const formData = new FormData();
                formData.append('file', file);

                console.log('Uploading to:', `${API_BASE}/upload-image`);

                const response = await fetch(`${API_BASE}/upload-image`, {
                    method: 'POST',
                    body: formData,
                });

                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error || `Upload failed: ${response.status}`);
                }

                const data = await response.json();
                console.log('Upload response:', data);

                sessionId = data.session_id;
                testSpec = data.test_spec;

                showTestSection();
            } catch (error) {
                console.error('Upload error:', error);
                document.getElementById('upload-error').textContent = 
                    `Error: ${error.message}. Is the backend running on ${API_BASE}?`;
                document.getElementById('upload-error').classList.remove('hidden');
            } finally {
                document.getElementById('upload-loading').classList.add('hidden');
            }
        }

        function showTestSection() {
            uploadSection.classList.add('hidden');
            testSection.classList.remove('hidden');
            resultsSection.classList.add('hidden');
            
            // ‚úÖ Initialize array with 16 positions: index 0 (reference) + indices 1-15 (colors to arrange)
            // Index 0 will always be the reference color (fixed)
            const referenceIndex = 0;
            userOrder = new Array(testSpec.n_colors + 1).fill(null);  // 16 total: 1 ref + 15 colors
            userOrder[0] = referenceIndex;  // Set reference at index 0
            
            document.getElementById('total-count').textContent = testSpec.n_colors;
            
            // Display reference color pad
            const referencePad = document.getElementById('reference-pad');
            if (testSpec.reference_color) {
                const rgb = testSpec.reference_color.rgb;
                referencePad.style.backgroundColor = `rgb(${rgb[0]}, ${rgb[1]}, ${rgb[2]})`;
            }
            
            renderPatchGrid();
        }

        function renderPatchGrid() {
            patchGrid.innerHTML = '';
            
            // üé≤ Use shuffled display order if available, otherwise use sequential order
            const displayOrder = testSpec.display_order || 
                                 testSpec.patch_configs.map((_, i) => i).filter(i => i !== 0);
            
            // Display colors in the shuffled order
            displayOrder.forEach(colorIndex => {
                const config = testSpec.patch_configs.find(c => c.color_index === colorIndex);
                if (!config) return;
                
                const rgb = config.rgb;
                const color = `rgb(${rgb[0]}, ${rgb[1]}, ${rgb[2]})`;

                const patch = document.createElement('div');
                patch.className = 'patch';
                patch.style.backgroundColor = color;
                patch.draggable = true;
                patch.dataset.colorIndex = config.color_index;

                const isUsed = userOrder.includes(config.color_index);
                if (isUsed) {
                    patch.classList.add('used');
                    patch.draggable = false;
                }

                patch.addEventListener('dragstart', () => {
                    if (!isUsed) {
                        draggedElement = patch;
                        patch.style.opacity = '0.5';
                    }
                });

                patch.addEventListener('dragend', () => {
                    patch.style.opacity = '1';
                });

                patchGrid.appendChild(patch);
            });

            renderOrderingZone();
        }

        function renderOrderingZone() {
            const container = document.getElementById('ordered-patches');
            container.innerHTML = '';

            // ‚úÖ Render slots 1-15 (skip index 0 which is the reference)
            for (let i = 1; i < userOrder.length; i++) {
                const colorIndex = userOrder[i];

                if (colorIndex !== null && colorIndex !== undefined && colorIndex >= 0) {
                    const config = testSpec.patch_configs.find(c => c.color_index === colorIndex);
                    if (config) {
                        const rgb = config.rgb;
                        const patch = document.createElement('div');
                        patch.className = 'ordered-patch';
                        patch.style.backgroundColor = `rgb(${rgb[0]}, ${rgb[1]}, ${rgb[2]})`;
                        patch.innerHTML = `<div class="patch-index">${i}</div>`;  // Show slot number 1-15
                        patch.onclick = () => removeFromSlot(i);
                        patch.addEventListener('dragover', (e) => e.preventDefault());
                        patch.addEventListener('drop', () => addToSlot(i));
                        container.appendChild(patch);
                    }
                } else {
                    const emptySlot = document.createElement('div');
                    emptySlot.className = 'empty-slot';
                    emptySlot.textContent = i;  // Show slot number 1-15
                    emptySlot.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        emptySlot.style.transform = 'scale(1.1)';
                    });
                    emptySlot.addEventListener('dragleave', () => {
                        emptySlot.style.transform = 'scale(1)';
                    });
                    emptySlot.addEventListener('drop', () => {
                        emptySlot.style.transform = 'scale(1)';
                        addToSlot(i);
                    });
                    container.appendChild(emptySlot);
                }
            }

            // Count placed colors (excluding index 0 reference)
            const placedCount = userOrder.slice(1).filter(x => x !== null && x !== undefined && x >= 0).length;
            document.getElementById('progress-count').textContent = placedCount;
            
            // Enable submit when all 15 slots (1-15) are filled
            submitBtn.disabled = placedCount !== testSpec.n_colors;
        }

        function addToSlot(slotIndex) {
            if (!draggedElement) return;
            
            const colorIndex = parseInt(draggedElement.dataset.colorIndex);
            
            if (userOrder.includes(colorIndex)) {
                showError('This color is already used!');
                return;
            }
            
            userOrder[slotIndex] = colorIndex;
            renderPatchGrid();
        }

        function removeFromSlot(slotIndex) {
            userOrder[slotIndex] = null;
            renderPatchGrid();
        }

        function showError(message) {
            const errorEl = document.getElementById('test-error');
            errorEl.textContent = message;
            errorEl.classList.remove('hidden');
            setTimeout(() => errorEl.classList.add('hidden'), 3000);
        }

        submitBtn.addEventListener('click', async () => {
            try {
                // Use the complete user order (including reference color)
                const completeOrder = userOrder;
                
                console.log('Submitting order with reference:', completeOrder);

                testSection.classList.add('hidden');
                resultsSection.classList.remove('hidden');
                document.getElementById('results-loading').classList.remove('hidden');

                const response = await fetch(`${API_BASE}/submit-response`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        session_id: sessionId,
                        user_order: completeOrder
                    })
                });

                if (!response.ok) {
                    throw new Error(await response.text());
                }

                const data = await response.json();
                console.log('Results:', data);

                displayResults(data);
            } catch (error) {
                console.error('Submit error:', error);
                alert(`Error: ${error.message}`);
                testSection.classList.remove('hidden');
                resultsSection.classList.add('hidden');
            }
        });

        function displayResults(data) {
            document.getElementById('results-loading').classList.add('hidden');
            
            // Display D-15 Graph
            if (data.d15_graph) {
                const graphContainer = document.getElementById('d15-graph-container');
                const graphImg = document.getElementById('d15-graph');
                graphImg.src = `data:image/png;base64,${data.d15_graph}`;
                graphContainer.classList.remove('hidden');
                console.log('‚úì D-15 graph displayed');
            }
            
            // Display Hue Spectrum Error Visualization
            if (data.hue_spectrum) {
                const spectrumContainer = document.getElementById('hue-spectrum-container');
                const spectrumImg = document.getElementById('hue-spectrum');
                spectrumImg.src = `data:image/png;base64,${data.hue_spectrum}`;
                spectrumContainer.classList.remove('hidden');
                console.log('‚úì Hue spectrum displayed');
            }
            
            const geminiSection = document.getElementById('gemini-analysis');
            const geminiContent = document.getElementById('gemini-content');
            
            if (data.gemini_analysis && data.gemini_analysis.success) {
                geminiSection.classList.remove('hidden');
                geminiContent.innerHTML = formatMarkdown(data.gemini_analysis.ai_analysis);
            } else {
                geminiSection.classList.remove('hidden');
                geminiContent.innerHTML = `
                    <div class="error-message">
                        <strong>‚ö†Ô∏è Gemini AI Analysis Unavailable</strong>
                        <p>${data.gemini_analysis?.error || 'Please configure GEMINI_API_KEY in your backend.'}</p>
                        <p style="margin-top: 15px;">
                            Get your free API key: 
                            <a href="https://makersuite.google.com/app/apikey" target="_blank" 
                               style="color: #1a73e8; font-weight: 600;">
                                Google AI Studio ‚Üí
                            </a>
                        </p>
                    </div>
                `;
            }
        }

        function formatMarkdown(text) {
            return text
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                .replace(/^## (.+)$/gm, '<h2>$1</h2>')
                .replace(/^### (.+)$/gm, '<h3>$1</h3>')
                .replace(/^#### (.+)$/gm, '<h4>$1</h4>')
                .replace(/^- (.+)$/gm, '<li>$1</li>')
                .replace(/^‚Ä¢ (.+)$/gm, '<li>$1</li>')
                .replace(/^\d+\. (.+)$/gm, '<li>$1</li>')
                .replace(/(<li>.*?<\/li>\s*)+/gs, match => `<ul>${match}</ul>`)
                .replace(/\n\n/g, '<br><br>');
        }

        document.getElementById('reset-btn').onclick = () => {
            userOrder = new Array(testSpec.n_colors).fill(null);
            renderPatchGrid();
        };

        document.getElementById('upload-new-btn').onclick = () => {
            fileInput.value = '';
            uploadSection.classList.remove('hidden');
            testSection.classList.add('hidden');
            resultsSection.classList.add('hidden');
        };

        document.getElementById('test-again-btn').onclick = () => {
            showTestSection();
        };
    </script>
</body>
</html>

